<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CLAUDE.md • sourcoise</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" sizes="any" href="favicon.ico"><link rel="manifest" href="site.webmanifest"><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="CLAUDE.md"><meta property="og:image" content="https://xtimbeau.github.io/sourcoise/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">sourcoise</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.2.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="articles/sourcoise.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/advanced.html">Usages avancés</a></li>
    <li><a class="dropdown-item" href="articles/compared.html">Comparé à ...</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/xtimbeau/sourcoise/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="logo.png" class="logo" alt=""><h1>CLAUDE.md</h1>
      <small class="dont-index">Source: <a href="https://github.com/xtimbeau/sourcoise/blob/main/CLAUDE.md" class="external-link"><code>CLAUDE.md</code></a></small>
    </div>

<div id="claudemd" class="section level1">

<p>This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.</p>
<div class="section level2">
<h2 id="package-overview">Package Overview<a class="anchor" aria-label="anchor" href="#package-overview"></a></h2>
<p><a href="https://xtimbeau.github.io/sourcoise/">sourcoise</a> is an R package that provides intelligent caching for R scripts. It acts as a drop-in replacement for <code><a href="https://rdrr.io/r/base/source.html" class="external-link">base::source()</a></code> but with persistent disk-based caching across sessions. The package is designed to work seamlessly with Quarto projects and GitHub workflows.</p>
<p><strong>Core concept</strong>: Execute R scripts that fetch data from files/APIs, cache the results to disk, and reuse cached data when nothing has changed. This enables fast rendering of Quarto documents even when APIs are slow or unavailable.</p>
</div>
<div class="section level2">
<h2 id="development-commands">Development Commands<a class="anchor" aria-label="anchor" href="#development-commands"></a></h2>
<div class="section level3">
<h3 id="package-building-and-testing">Package Building and Testing<a class="anchor" aria-label="anchor" href="#package-building-and-testing"></a></h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load package for development</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">load_all</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run all tests</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">test</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run specific test file</span></span>
<span><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_file.html" class="external-link">test_file</a></span><span class="op">(</span><span class="st">"tests/testthat/test-sourcoise.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check package (R CMD check)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">check</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build documentation</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">document</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build README from README.Rmd</span></span>
<span><span class="fu">rmarkdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgs.rstudio.com/rmarkdown/reference/render.html" class="external-link">render</a></span><span class="op">(</span><span class="st">"README.Rmd"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="code-quality">Code Quality<a class="anchor" aria-label="anchor" href="#code-quality"></a></h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check code coverage</span></span>
<span><span class="fu">covr</span><span class="fu">::</span><span class="fu"><a href="http://covr.r-lib.org/reference/package_coverage.html" class="external-link">package_coverage</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="installation-for-testing">Installation for Testing<a class="anchor" aria-label="anchor" href="#installation-for-testing"></a></h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install from local source</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Install with dependencies</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_deps</span><span class="op">(</span>dependencies <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="architecture">Architecture<a class="anchor" aria-label="anchor" href="#architecture"></a></h2>
<div class="section level3">
<h3 id="core-function-flow">Core Function Flow<a class="anchor" aria-label="anchor" href="#core-function-flow"></a></h3>
<p>The package has a two-layer architecture for the main <code><a href="reference/sourcoise.html">sourcoise()</a></code> function:</p>
<ol style="list-style-type: decimal"><li>
<strong><code><a href="reference/sourcoise.html">sourcoise()</a></code></strong> (R/sourcoise.R:91-122) - User-facing wrapper that collects options from global settings</li>
<li>
<strong><code>sourcoise_()</code></strong> (R/sourcoise.R:126-229) - Internal implementation handling cache logic</li>
</ol><p><strong>Execution flow</strong>:</p>
<pre><code>sourcoise()
  → setup_context() [finds files, sets up paths, initializes logging]
  → valid_metas() [checks cache validity]
  → exec_source() [executes script if needed]
  → cache_data() [saves results to disk]
  → data_returned() [formats output]</code></pre>
</div>
<div class="section level3">
<h3 id="cache-invalidation-system">Cache Invalidation System<a class="anchor" aria-label="anchor" href="#cache-invalidation-system"></a></h3>
<p>Cache is invalidated when any of these conditions are met (R/sourcoise.R:13-18):</p>
<ol style="list-style-type: decimal"><li>No cache found</li>
<li>Source script modified (detected via hash)</li>
<li>Tracked files modified (via <code>track</code> parameter)</li>
<li>Cache expired based on <code>lapse</code> parameter</li>
<li>Execution forced via <code>force_exec=TRUE</code>
</li>
</ol></div>
<div class="section level3">
<h3 id="module-organization">Module Organization<a class="anchor" aria-label="anchor" href="#module-organization"></a></h3>
<ul><li>
<strong>R/sourcoise.R</strong> - Main entry point and cache decision logic</li>
<li>
<strong>R/cache_tools.R</strong> - Cache writing, reading, and hash management</li>
<li>
<strong>R/exec_tools.R</strong> - Script execution in isolated environment</li>
<li>
<strong>R/setup_tools.R</strong> - Context setup: finds project root, resolves paths</li>
<li>
<strong>R/path_tools.R</strong> - Path resolution and file finding heuristics</li>
<li>
<strong>R/metadata_tools.R</strong> - JSON metadata reading/writing/validation</li>
<li>
<strong>R/sourcoise_status.R</strong> - Cache inspection across project</li>
<li>
<strong>R/sourcoise_refresh.R</strong> - Batch cache refresh with progress tracking</li>
<li>
<strong>R/sourcoise_clear.R</strong> - Cache cleanup utilities</li>
<li>
<strong>R/other_tools.R</strong> - Quarto-specific helpers (unfreeze, uncache)</li>
</ul></div>
<div class="section level3">
<h3 id="key-design-patterns">Key Design Patterns<a class="anchor" aria-label="anchor" href="#key-design-patterns"></a></h3>
<p><strong>Project Root Detection</strong> (R/setup_tools.R): - Uses <code>rprojroot</code> to find project root (.Rproj file, git repo, etc.) - Falls back to multiple heuristics if standard detection fails - Supports manual override via <code>options(sourcoise.root = path)</code></p>
<p><strong>File Finding Heuristic</strong> (R/path_tools.R): - When script path is incomplete, searches entire project - Selects closest match to caller’s working directory - Warns when multiple matches found</p>
<p><strong>Working Directory Management</strong> (R/exec_tools.R:15-21): - Script executed with <code><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd()</a></code> to script’s directory (by default) - Original directory restored via <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> - Enables portable scripts with relative paths to companion files</p>
<p><strong>Hash-Based Naming</strong> (R/cache_tools.R): - Cache files named: <code>{script}_{hash}-{uid}-{counter}.qs2</code> - Hash based on script content, args, tracked files - Avoids cache collision across different machines/users</p>
<p><strong>Serialization</strong>: Uses <code>qs2</code> package for fast, cross-platform binary serialization</p>
<p><strong>Error Recovery</strong> (R/sourcoise.R:208-222): - If script fails but cache exists, returns cached data (possibly invalid) - Logs error but doesn’t block document rendering - Critical for handling unreliable APIs</p>
</div>
</div>
<div class="section level2">
<h2 id="global-options">Global Options<a class="anchor" aria-label="anchor" href="#global-options"></a></h2>
<p>Configure package behavior via <code><a href="https://rdrr.io/r/base/options.html" class="external-link">options()</a></code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span></span>
<span>  sourcoise.root <span class="op">=</span> <span class="cn">NULL</span>,           <span class="co"># Force project root path</span></span>
<span>  sourcoise.src_in <span class="op">=</span> <span class="st">"project"</span>,    <span class="co"># "project" or "file" for cache location</span></span>
<span>  sourcoise.nocache <span class="op">=</span> <span class="cn">FALSE</span>,       <span class="co"># Disable caching entirely</span></span>
<span>  sourcoise.log <span class="op">=</span> <span class="st">"OFF"</span>,           <span class="co"># Log threshold: "OFF", "INFO", "DEBUG"</span></span>
<span>  sourcoise.grow_cache <span class="op">=</span> <span class="fl">5</span>,        <span class="co"># Max number of cache versions kept</span></span>
<span>  sourcoise.limit_mb <span class="op">=</span> <span class="fl">50</span>,         <span class="co"># Max individual cache file size (MB)</span></span>
<span>  sourcoise.force_exec <span class="op">=</span> <span class="cn">FALSE</span>,    <span class="co"># Force execution globally</span></span>
<span>  sourcoise.prevent_exec <span class="op">=</span> <span class="cn">FALSE</span>,  <span class="co"># Prevent execution globally</span></span>
<span>  sourcoise.metadata <span class="op">=</span> <span class="cn">FALSE</span>,      <span class="co"># Return metadata by default</span></span>
<span>  sourcoise.wd <span class="op">=</span> <span class="st">"file"</span>,           <span class="co"># Working dir: "file", "project", "qmd"</span></span>
<span>  sourcoise.lapse <span class="op">=</span> <span class="st">"never"</span>,       <span class="co"># Default expiry: "never", "1 day", etc.</span></span>
<span>  sourcoise.encoding <span class="op">=</span> <span class="st">"UTF-8"</span>,    <span class="co"># Source file encoding</span></span>
<span>  sourcoise.init_fn <span class="op">=</span> <span class="cn">NULL</span>         <span class="co"># Function to run before refresh</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="testing-notes">Testing Notes<a class="anchor" aria-label="anchor" href="#testing-notes"></a></h2>
<ul><li>Test suite uses <code><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir()</a></code> for isolated cache directories</li>
<li>Key test file: <code>tests/testthat/test-sourcoise.R</code>
</li>
<li>Tests copy example scripts from <code>inst/</code> directory</li>
<li>Must set root explicitly in tests: <code>set_sourcoise_root(dir)</code>
</li>
<li>Test examples include INSEE API calls (conditional on package availability)</li>
</ul></div>
<div class="section level2">
<h2 id="cache-structure">Cache Structure<a class="anchor" aria-label="anchor" href="#cache-structure"></a></h2>
<p>Cache stored in <code>.sourcoise/</code> directory (hidden, but committed to git):</p>
<pre><code>.sourcoise/
  {script_dir}/
    {script_name}-{args_hash}/
      {script_name}_{src_hash}-{uid}-{counter}.json  # Metadata
      {script_name}-{data_hash}.qs2                  # Cached data</code></pre>
<p><strong>Metadata JSON contains</strong>: - Execution date, timing, data size - Script hash, tracked file hashes, args hash, data hash - Cache validity status - Associated .qmd files (for Quarto projects) - Log file path</p>
</div>
<div class="section level2">
<h2 id="quarto-integration">Quarto Integration<a class="anchor" aria-label="anchor" href="#quarto-integration"></a></h2>
<p>When <code><a href="reference/sourcoise.html">sourcoise()</a></code> is called from a .qmd file:</p>
<ol style="list-style-type: decimal"><li>Detects calling .qmd file path</li>
<li>Stores association in cache metadata</li>
<li>
<code><a href="reference/sourcoise_refresh.html">sourcoise_refresh()</a></code> can unfreeze/uncache related .qmd files</li>
<li>Enables workflow: refresh data → auto-unfreeze docs → re-render</li>
</ol></div>
<div class="section level2">
<h2 id="important-implementation-details">Important Implementation Details<a class="anchor" aria-label="anchor" href="#important-implementation-details"></a></h2>
<p><strong>Priority System</strong> (R/sourcoise_refresh.R:23): - Scripts can set <code>priority</code> parameter (default 10) - Higher priority scripts execute first during refresh - Enables cascading <code><a href="reference/sourcoise.html">sourcoise()</a></code> calls (script A calls script B)</p>
<p><strong>User ID per Machine</strong> (R/setup_tools.R:36): - UID is CRC32 hash of project root path - Different machines have different UIDs - Prevents cache conflicts on shared repos</p>
<p><strong>Data Deduplication</strong> (R/cache_tools.R:13-40): - Before caching, checks if data hash matches existing cache - If identical, reuses existing .qs2 file - Saves disk space and reduces writes</p>
<p><strong>Size Limit Safety</strong> (global option <code>sourcoise.limit_mb</code>): - If cached object exceeds limit, no caching occurs - Prevents bloating repository with large files</p>
</div>
<div class="section level2">
<h2 id="common-patterns">Common Patterns<a class="anchor" aria-label="anchor" href="#common-patterns"></a></h2>
<p><strong>Basic usage in .qmd</strong>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://xtimbeau.github.io/sourcoise/">sourcoise</a></span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sourcoise.html">sourcoise</a></span><span class="op">(</span><span class="st">"scripts/fetch_data.R"</span><span class="op">)</span></span>
<span><span class="co"># Use data for plotting/analysis</span></span></code></pre></div>
<p><strong>With tracked files</strong>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sourcoise.html">sourcoise</a></span><span class="op">(</span><span class="st">"analysis.R"</span>, track <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"raw_data.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Re-executes when raw_data.csv changes</span></span></code></pre></div>
<p><strong>With periodic refresh</strong>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sourcoise.html">sourcoise</a></span><span class="op">(</span><span class="st">"api_call.R"</span>, lapse <span class="op">=</span> <span class="st">"1 day"</span><span class="op">)</span></span>
<span><span class="co"># Re-executes once per day</span></span></code></pre></div>
<p><strong>Refresh all invalid caches</strong>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/sourcoise_refresh.html">sourcoise_refresh</a></span><span class="op">(</span>force_exec <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Only invalid</span></span>
<span><span class="fu"><a href="reference/sourcoise_refresh.html">sourcoise_refresh</a></span><span class="op">(</span>force_exec <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>   <span class="co"># Force all</span></span></code></pre></div>
<p><strong>Check cache status</strong>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">status</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sourcoise_status.html">sourcoise_status</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Returns tibble with all cache info</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="style-conventions">Style Conventions<a class="anchor" aria-label="anchor" href="#style-conventions"></a></h2>
<p>This codebase follows modern tidyverse patterns per the top-level CLAUDE.md Modern R Development Guide. When contributing:</p>
<ul><li>Use native pipe <code>|&gt;</code> not <code>%&gt;%</code>
</li>
<li>Use <code>.by</code> for per-operation grouping</li>
<li>Use <code>cli</code> package for user messages</li>
<li>Use <code>logger</code> for internal logging</li>
<li>Use modern join syntax with <code>join_by()</code>
</li>
<li>Follow tidyverse style guide (snake_case, spacing)</li>
</ul></div>
<div class="section level2">
<h2 id="dependencies">Dependencies<a class="anchor" aria-label="anchor" href="#dependencies"></a></h2>
<p><strong>Core runtime dependencies</strong> (from DESCRIPTION): - <code>qs2</code> - Fast serialization - <code>cli</code> - User messages - <code>digest</code> - Hashing - <code>fs</code> - Cross-platform file operations - <code>purrr</code>, <code>dplyr</code>, <code>tibble</code> - Data manipulation - <code>lubridate</code> - Date handling - <code>stringr</code>, <code>glue</code> - String operations - <code>rprojroot</code> - Project root detection - <code>rlang</code> - Tidy evaluation - <code>logger</code> - Logging - <code>jsonlite</code> - Metadata storage - <code>lobstr</code> - Object size calculation - <code>scales</code> - Size formatting</p>
<p><strong>Suggested packages</strong>: - <code>testthat</code> - Testing - <code>bench</code> - Performance measurement - <code>memoise</code> - Additional memoization - <code>quarto</code> - Quarto integration</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Xavier Timbeau. hand made with love in France</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

