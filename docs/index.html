<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Exec a script, like source, and cache results on disk • sourcoise</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/Open_Sans-0.4.9/font.css" rel="stylesheet">
<link href="deps/Fira_Code-0.4.9/font.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Exec a script, like source, and cache results on disk">
<meta name="description" content="provide a function that behave nearly as base::source() but provide a caching mechanism on disk. Allows to source() R scripts that gather data but can fail or consume to much time to respond even if nothing new is expected. Comes with a bunch of tools to execute periodically, when cache is invalid of force refresh of the cache.">
<meta property="og:description" content="provide a function that behave nearly as base::source() but provide a caching mechanism on disk. Allows to source() R scripts that gather data but can fail or consume to much time to respond even if nothing new is expected. Comes with a bunch of tools to execute periodically, when cache is invalid of force refresh of the cache.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">sourcoise</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="articles/sourcoise.html">Démmarer avec soucrcoise()</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ofce/ofce"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="mise-en-cache-avec-sourcoise">mise en cache avec sourcoise<a class="anchor" aria-label="anchor" href="#mise-en-cache-avec-sourcoise"></a>
</h1></div>
<p><code>{sourcoise}</code> est un package qui fournit des outils pour exécuter un script R et mettre en cache les résultats. Le but est de pouvoir exécuter très rapidement un code qui accède à des fichiers ou une API et qui, en l’absence de mises à jour, produit toujours le même résultat. Lorsque l’API est suceptible de bloquer (ou si on a pas de connection internet), cela évite de bloquer le rendu d’un document ou d’un site quarto.</p>
<p>Accessoirement, cela oblige à isoler le code du script qui récupère les données dans un fichier afin d’améliorer la reproductibilité. <code><a href="reference/sourcoise.html">sourcoise()</a></code> peut être appelé dans un <code><a href="reference/sourcoise.html">sourcoise()</a></code> ce qui permet la modularité. Il fournit des outils pour vérifier le cache et le rafraichir à la demande.</p>
<div class="section level2">
<h2 id="utilisation">utilisation<a class="anchor" aria-label="anchor" href="#utilisation"></a>
</h2>
<p>La structure est donc :</p>
<ul>
<li><p>un projet R ou quarto.</p></li>
<li><p>des qmd, appelant <code><a href="reference/sourcoise.html">sourcoise()</a></code> pour l’acquisition des données et produisant tableaux ou graphiques à partir de ces données.</p></li>
<li><p>des scripts <code>R</code>, dans le même dossier ou ailleurs, qui produisent les données à partir de calculs, d’interrogation de bases externes ou d’API. Des objets plus complexes peuvent être renvoyés, comme par exemple des listes d’objets, des graphiques, des tableaux, des fonctions fabriquant des tableaux ou des graphiques, etc…</p></li>
<li><p>lorsqu’un cache est disponible et valide (voir plus bas) il est utilisé et la fonction répond très rapidement suivant la taille des données (0.006 secondes pour des données de 2Mb).</p></li>
<li><p>tout cela est conçu pour fonctionner avec <em>github</em> et donc partager le cache entre utilisateurs d’un même dépot. On peut donc mettre à jour les données sur une machine et les utiliser sur une autre.</p></li>
</ul>
<p>Par exemple, si le script <code>R</code> <code>prix_insee.r</code> utilise l’API de l’INSEE pour télécharger l’indice des prix à la consommation, et si il se termine par l’instruction <code>return(ipc)</code>, alors <code>sourcoise("prix_insee.r")</code> renvoie toujours les données correspondantes, et si elles sont en cache, le retour est très rapide et ne nécessite pas d’accès à internet.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pyr-opendatafr.github.io/R-Insee-Data/" class="external-link">insee</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">ipchm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://pyr-opendatafr.github.io/R-Insee-Data/reference/get_idbank_list.html" class="external-link">get_idbank_list</a></span><span class="op">(</span><span class="st">"IPCH-2015"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">COICOP2016</span><span class="op">==</span><span class="st">"00"</span>, <span class="va">FREQ</span><span class="op">==</span><span class="st">"M"</span>, <span class="va">NATURE</span><span class="op">==</span><span class="st">"INDICE"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">idbank</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu"><a href="https://pyr-opendatafr.github.io/R-Insee-Data/reference/get_insee_idbank.html" class="external-link">get_insee_idbank</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">DATE</span>, ipch <span class="op">=</span> <span class="va">OBS_VALUE</span>, <span class="va">IDBANK</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ipch</span> <span class="op">&lt;-</span> <span class="va">ipchm</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>DATE <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html" class="external-link">floor_date</a></span><span class="op">(</span><span class="va">DATE</span>, unit<span class="op">=</span><span class="st">"quarter"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">DATE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>ipch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ipch</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ipcha</span> <span class="op">&lt;-</span> <span class="va">ipch</span> <span class="op">|&gt;</span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">DATE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>ipch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ipch</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ipch <span class="op">=</span> <span class="va">ipch</span> <span class="op">/</span> <span class="va">ipch</span><span class="op">[</span><span class="va">y</span> <span class="op">==</span> <span class="fl">2023</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ipcha <span class="op">=</span> <span class="va">ipcha</span>, ipchm <span class="op">=</span> <span class="va">ipchm</span>, ipch <span class="op">=</span> <span class="va">ipch</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Dans le <code>qmd</code> on a alors un chunk <code>r</code> :</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">sourcoise</span><span class="op">)</span></span>
<span><span class="va">ipc</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sourcoise.html">sourcoise</a></span><span class="op">(</span><span class="st">"prix_insee.r"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">ipc</span><span class="op">$</span><span class="va">ipch</span><span class="op">)</span> <span class="op">+</span> <span class="va">...</span></span></code></pre></div>
<p>Le stockage des données a une faible empreinte disque (elles ne servent qu’à construire un graphique, il y a donc une série ou deux, trois dans cet exemple), ce qui ne pose pas de problème pour <em>github</em>. Si l’API de l’INSEE est en panne, alors le cache sera utilisé. On peut réutiliser cette instruction de nombreuses fois, puisqu’elle ne sera exécuté réellement qu’une fois et que les autres fois, c’est le cache qui est utilisé.</p>
<p><code><a href="reference/sourcoise.html">sourcoise()</a></code> exécute le script en local, ce qui limite les effets de bord.</p>
</div>
<div class="section level2">
<h2 id="par-rapport-à-memoise">par rapport à <em>memoise</em>
<a class="anchor" aria-label="anchor" href="#par-rapport-%C3%A0-memoise"></a>
</h2>
<p>Par rapport à <code><a href="https://memoise.r-lib.org/reference/memoise.html" class="external-link">memoise::memoise()</a></code>, <code><a href="reference/sourcoise.html">sourcoise()</a></code> utilise systématiquement un cache, localisé dans le projet R ou quarto et destiné à être synchronisé par github. Il s’applique à un script et non à une fonction et utilise des règles d’invalidation du cache légèrement différentes :</p>
<ul>
<li>le cache est conçu principalement pour être passé entre session. Il est utilisé lors du rendu d’un <code>.qmd</code> et il est transportable avec les fichiers associés.</li>
<li>le cache est invalidé si le script est modifié (similaire à l’invalidation par le corps de la fonction dans <code><a href="https://memoise.r-lib.org/reference/memoise.html" class="external-link">memoise::memoise()</a></code>).</li>
<li>le cache est invalidé en fonction du delai entre deux exécutions. Il est possible de ré-exécuter le code si il n’a pas été exécuté depuis une heure, une journée, une semaine, etc…</li>
<li>le cache est invalidé si un ou plusieurs fichiers (définis au préalable) ont été modifiés. Cela sert en particulier à invalider le cache si un fichier de données (<code>.csv</code> ou <code>.xls</code>) a été modifié.</li>
<li>le cache est invalidé si les arguments passés à <code><a href="reference/sourcoise.html">sourcoise()</a></code> pour le script ont été modifiés (comme dans <code><a href="https://memoise.r-lib.org/reference/memoise.html" class="external-link">memoise::memoise()</a></code>).</li>
<li>on peut également forcer l’invalidation du cache par un paramètre passé à la fonction, éventuellement un paramètre global ou en utilisant la fonction <code><a href="reference/sourcoise_refresh.html">sourcoise_refresh()</a></code>. Ce dernier point est une différence important par rapport à <code><a href="https://memoise.r-lib.org/reference/memoise.html" class="external-link">memoise::memoise()</a></code> et permet une exécution régulière du rafraichissement du cache.</li>
<li>on peut <em>logger</em> les accès à <code><a href="reference/sourcoise.html">sourcoise()</a></code> ce qui permet de comprendre pourquoi le cache n’est pas invalidé et quels sont fichiers qui ont déclenché <code><a href="reference/sourcoise.html">sourcoise()</a></code>. Un dossier <code>.logs</code> est ajouté au dossier du projet.</li>
<li>on peut limiter la taille du cache, par le paramètre <code>grow_cache</code> qui contraint l’historique du cache et par <code>limit_mb</code> qui empêche de mettre en cache des données au delà d’une taille limite ; par défaut 50mb, pour ne pas fâcher <em>github</em>.</li>
<li>une heuristique maline trouve le fichier source même si il est caché (i.e. que le chemin est approximatif, ce qui déclenche une erreur), ce qui augmente la portabilité des fichiers sources.</li>
</ul>
</div>
<div class="section level2">
<h2 id="autres-fonctionalités">autres fonctionalités<a class="anchor" aria-label="anchor" href="#autres-fonctionalit%C3%A9s"></a>
</h2>
<p><code><a href="reference/sourcoise.html">sourcoise()</a></code> peut également invalider les <em>freeze</em> employés par quarto. Les qmd appelant le script sont enregistrés avec le cache et lorsque celui-ci est rafraichit, alors le <code>qmd</code> est <em>unfreezé</em>, ce qui assure que le qmd sera bien re rendu avec les données mises à jour.</p>
<p><code><a href="reference/sourcoise.html">sourcoise()</a></code> conserve l’histoirique des données téléchargées et permet donc théoriquement d’y acceder.</p>
<p><code><a href="reference/sourcoise.html">sourcoise()</a></code> utilise une heuristique pour trouver la racine du projet, et localiser le script R qui est appelé. cela permet la transportabilité des scripts à l’intérieur d’un projet.</p>
</div>
<div class="section level2">
<h2 id="à-venir">à venir<a class="anchor" aria-label="anchor" href="#%C3%A0-venir"></a>
</h2>
<p>Seront bientôt implémentés :</p>
<ul>
<li><p>la possibiité de stocker les données cachées hors de <em>github</em> et d’utiliser <a href="https://pins.rstudio.com/" class="external-link">pins</a> pour les partager (mais au prix d’un accès plus lent peut être).</p></li>
<li><p>et éventuellement une interface <em>shiny</em> de mise à jour (<em>gui</em> pour <code><a href="reference/sourcoise_refresh.html">sourcoise_refresh()</a></code>)</p></li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing sourcoise</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Xavier Timbeau <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Xavier Timbeau.</p>
</div>

<div class="pkgdown-footer-right">
  <p>RTFM CC BY 4.0 Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
