<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Comparé à … • sourcoise</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="compared_files/libs/quarto-html/popper.min.js"></script><script src="compared_files/libs/quarto-html/tippy.umd.min.js"></script><link href="compared_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="compared_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Comparé à …">
<meta property="og:image" content="https://xtimbeau.github.io/sourcoise/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sourcoise</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/sourcoise.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/advanced.html">Usages avancés</a></li>
    <li><a class="dropdown-item" href="../articles/compared.html">Comparé à ...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/xtimbeau/sourcoise/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Comparé à …</h1>




      <small class="dont-index">Source: <a href="https://github.com/xtimbeau/sourcoise/blob/main/vignettes/compared.qmd" class="external-link"><code>vignettes/compared.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <section class="level2"><h2 id="par-rapport-à-basesource">par rapport à base::source<a class="anchor" aria-label="anchor" href="#par-rapport-%C3%A0-basesource"></a>
</h2>
<p>Une alternative à <code><a href="../reference/sourcoise.html">sourcoise()</a></code> est d’écrire l’enregistrement des données directement dans le script et de charger les données dans le chunk.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pyr-opendatafr.github.io/R-Insee-Data/" class="external-link">insee</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">ipchm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://pyr-opendatafr.github.io/R-Insee-Data/reference/get_idbank_list.html" class="external-link">get_idbank_list</a></span><span class="op">(</span><span class="st">"IPCH-2015"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">COICOP2016</span><span class="op">==</span><span class="st">"00"</span>, <span class="va">FREQ</span><span class="op">==</span><span class="st">"M"</span>, <span class="va">NATURE</span><span class="op">==</span><span class="st">"INDICE"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>     <span class="fu">pull</span><span class="op">(</span><span class="va">idbank</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu"><a href="https://pyr-opendatafr.github.io/R-Insee-Data/reference/get_insee_idbank.html" class="external-link">get_insee_idbank</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu">select</span><span class="op">(</span><span class="va">DATE</span>, ipch <span class="op">=</span> <span class="va">OBS_VALUE</span>, <span class="va">IDBANK</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ipch</span> <span class="op">&lt;-</span> <span class="va">ipchm</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu">mutate</span><span class="op">(</span>DATE <span class="op">=</span> <span class="fu">floor_date</span><span class="op">(</span><span class="va">DATE</span>, unit<span class="op">=</span><span class="st">"quarter"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu">group_by</span><span class="op">(</span><span class="va">DATE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu">summarise</span><span class="op">(</span>ipch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ipch</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ipcha</span> <span class="op">&lt;-</span> <span class="va">ipch</span> <span class="op">|&gt;</span> </span>
<span>     <span class="fu">mutate</span><span class="op">(</span>y <span class="op">=</span> <span class="fu">year</span><span class="op">(</span><span class="va">DATE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>     <span class="fu">group_by</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu">summarize</span><span class="op">(</span>ipch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ipch</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>     <span class="fu">mutate</span><span class="op">(</span>ipch <span class="op">=</span> <span class="va">ipch</span> <span class="op">/</span> <span class="va">ipch</span><span class="op">[</span><span class="va">y</span> <span class="op">==</span> <span class="fl">2023</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">ipcha</span> , <span class="va">ipchm</span>,  <span class="va">ipch</span>, file <span class="op">=</span> <span class="st">"ipch.rds"</span><span class="op">)</span></span></code></pre></div>
<p>et dans le chunk <code>r</code> inclure un <code>loadRDS("ipch.rds")</code>. En apparence plus simple cette solution est désastreuse pour le <em>workflow.</em> On ne sait pas quel script il faut lancer, quand il a été lancé, le chargement du script modifie les variables dans l’environnement, les <code>.rds</code> déclenchent des conflits avec <em>github</em>, bref, que des mauvaises pratiques.</p>
</section><section class="level2"><h2 id="par-rapport-à-memoise">par rapport à memoise<a class="anchor" aria-label="anchor" href="#par-rapport-%C3%A0-memoise"></a>
</h2>
<p><code><a href="https://memoise.r-lib.org/reference/memoise.html" class="external-link">memoise::memoise()</a></code> propose une solution proche, avec la possibilité de rendre le cache persistant entre sessions.</p>
<p>Mais <code>memoise()</code> répond au besoin de l’évaluation d’une fonction, qui pour un même jeu de paramètres renvoie toujours la même chose. Ce qui est la définition d’une fonction dans la paradigme fonctionnel. Le cache permet alors d’échanger espace disque contre performance.</p>
<p><code><a href="../reference/sourcoise.html">sourcoise()</a></code> part d’une hypothèse différente, celle d’effets de bord. Le code appelé par le script ressemble à une fonction mais n’en est pas une : les mêmes arguments peuvent renvoyer une valeur différente. C’est le cas notamment lors de l’accès à une API à des données qui renvoie souvent la même chose, mais périodiquement propose une nouvelle version, mise à jour, avec un effet de bord.</p>
<p>Le temps d’accès à l’API eut être long et éventuellement l’accès hasardeux (serveur hors ligne, internet coupé). Or les appels à l’API peuvent être dans un workflow typique quarto/R très fréquent (à chaque rendu par exemple), <code><a href="../reference/sourcoise.html">sourcoise()</a></code> permet donc de mettre en cache et de ne déclencher une “vraie” exécution que de temps en temps. Si l’appel à l’API est très long, le gain en performance peut être considérable. Si l’API bloque parfois, alors <code><a href="../reference/sourcoise.html">sourcoise()</a></code> permet de continuer le reste du workflow sans interruption. L’exécution de l’API peut ainsi être asynchrone, dans un process différent ou sur une machine différente, la synchronisation étant assurée par le système de fichier, github ou <a href="https://pins.rstudio.com/" class="external-link">pins</a> (à venir).</p>
<p>Par rapport à <code><a href="https://memoise.r-lib.org/reference/memoise.html" class="external-link">memoise::memoise()</a></code>, <code><a href="../reference/sourcoise.html">sourcoise()</a></code> utilise systématiquement un cache sur disque, persistant, localisé dans le projet R ou quarto et destiné à être synchronisé par github. Il s’applique à un script et non à une fonction et utilise des règles d’invalidation du cache différentes :</p>
<ul>
<li><p>le cache est conçu principalement pour être passé entre session. Il est utilisé lors du rendu d’un .qmd et il est transportable avec les fichiers associés.</p></li>
<li><p>le cache est invalidé si le script est modifié (similaire à l’invalidation par le corps de la fonction dans memoise::memoise()).</p></li>
<li><p>le cache est invalidé en fonction du delai entre deux exécutions. Il est possible de ré-exécuter le code si il n’a pas été exécuté depuis une heure, une journée, une semaine, etc…</p></li>
<li><p>le cache est invalidé si un ou plusieurs fichiers (définis au préalable) ont été modifiés. Cela sert en particulier à invalider le cache si un fichier de données (<code>.csv</code> ou <code>.xls</code>) a été modifié.</p></li>
<li><p>le cache est invalidé si les arguments passés à <code><a href="../reference/sourcoise.html">sourcoise()</a></code> pour le script ont été modifiés (comme dans le fonctionnement central de <code><a href="https://memoise.r-lib.org/reference/memoise.html" class="external-link">memoise::memoise()</a></code>).</p></li>
<li><p>on peut également forcer l’invalidation du cache par un paramètre passé à la fonction, éventuellement un paramètre global ou en utilisant la fonction <code><a href="../reference/sourcoise_refresh.html">sourcoise_refresh()</a></code>. Ce dernier point est une différence important par rapport à <code><a href="https://memoise.r-lib.org/reference/memoise.html" class="external-link">memoise::memoise()</a></code> et permet une exécution régulière du rafraichissement du cache indépendamment de l’endroit où est appelé le script.</p></li>
<li><p>on peut logger les accès à sourcoise() ce qui permet de comprendre pourquoi le cache n’est pas invalidé et quels sont fichiers qui ont déclenché sourcoise(). Un dossier <code>logs</code> est ajouté au dossier <code>.sourcoise</code>.</p></li>
<li><p>on peut limiter la taille du cache, par le paramètre grow_cache qui contraint l’historique du cache et par limit_mb qui empêche de mettre en cache des données au delà d’une taille limite ; par défaut 50mb, pour ne pas fâcher github.</p></li>
<li><p><code><a href="../reference/sourcoise.html">sourcoise()</a></code> utilise en fait <a href="https://memoise.r-lib.org" class="external-link">memoise</a> pour ne pas charger 2 fois les données à partir du disque. Le gain est marginal pour de petites données mais peut jouer lorsque les données sont volumineuses (divise par 100 l’accès pour des données de 50Mb, par 10 pour des données de 5Mb, par 2 pour 500kb).</p></li>
</ul></section><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config);
    }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Xavier Timbeau. hand made with love in France</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
