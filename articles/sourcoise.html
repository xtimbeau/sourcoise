<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>sourcoise() : plus rapide, plus sûr • sourcoise</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="sourcoise_files/libs/quarto-html/popper.min.js"></script><script src="sourcoise_files/libs/quarto-html/tippy.umd.min.js"></script><link href="sourcoise_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="sourcoise_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="sourcoise() : plus rapide, plus sûr">
<meta property="og:image" content="https://xtimbeau.github.io/sourcoise/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sourcoise</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/sourcoise.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/compared.html">Comparé à ...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>sourcoise() : plus rapide, plus sûr</h1>





      <div class="d-none name"><code></code></div>
    </div>






    <section class="section level2"><h2 id="mettre-en-cache-le-résultat-des-calculs-avec-sourcoise">Mettre en cache le résultat des calculs avec <code>sourcoise()</code>
<a class="anchor" aria-label="anchor" href="#mettre-en-cache-le-r%C3%A9sultat-des-calculs-avec-sourcoise"></a>
</h2>
<section class="level2"><h3 id="comment-lutiliser">Comment l’utiliser ?<a class="anchor" aria-label="anchor" href="#comment-lutiliser"></a>
</h3>
<p>1 - Mettre le code qui fabrique les données dans un script (<code>"ipch_PiM.r"</code>) et l’enregistrer dans le dossier où est le qmd. Dans cet exemple, le code <code>r</code> télécharge des données (assez volumineuses) sur Eurostat, les transforme et renvoie un tibble prêt pour le graphique. Le script doit se terminer par un <code>return</code> qui renvoie les données calculées ou téléchargées. Ce sont ces données qui sont mises en cache. Le temps d’exécution est de 11s et le script peut bloquer si l’API d’eurostat n’est pas accessible (ou si on a pas de connection internet).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> prix.qmd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> ipch</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">└──</span> prix_insee.R</span></code></pre></div>
<p>Le script <code>insee.r</code> comporte un <code><a href="https://rdrr.io/r/base/function.html" class="external-link">return()</a></code> à la fin :</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pyr-opendatafr.github.io/R-Insee-Data/" class="external-link">insee</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">ipchm</span> <span class="op">&lt;-</span> <span class="fu">get_idbank_list</span><span class="op">(</span><span class="st">"IPCH-2015"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">COICOP2016</span><span class="op">==</span><span class="st">"00"</span>, <span class="va">FREQ</span><span class="op">==</span><span class="st">"M"</span>, <span class="va">NATURE</span><span class="op">==</span><span class="st">"INDICE"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>     <span class="fu">pull</span><span class="op">(</span><span class="va">idbank</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu">get_insee_idbank</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu">select</span><span class="op">(</span><span class="va">DATE</span>, ipch <span class="op">=</span> <span class="va">OBS_VALUE</span>, <span class="va">IDBANK</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ipch</span> <span class="op">&lt;-</span> <span class="va">ipchm</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu">mutate</span><span class="op">(</span>DATE <span class="op">=</span> <span class="fu">floor_date</span><span class="op">(</span><span class="va">DATE</span>, unit<span class="op">=</span><span class="st">"quarter"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu">group_by</span><span class="op">(</span><span class="va">DATE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu">summarise</span><span class="op">(</span>ipch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ipch</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ipcha</span> <span class="op">&lt;-</span> <span class="va">ipch</span> <span class="op">|&gt;</span> </span>
<span>     <span class="fu">mutate</span><span class="op">(</span>y <span class="op">=</span> <span class="fu">year</span><span class="op">(</span><span class="va">DATE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>     <span class="fu">group_by</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>     <span class="fu">summarize</span><span class="op">(</span>ipch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ipch</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>     <span class="fu">mutate</span><span class="op">(</span>ipch <span class="op">=</span> <span class="va">ipch</span> <span class="op">/</span> <span class="va">ipch</span><span class="op">[</span><span class="va">y</span> <span class="op">==</span> <span class="fl">2023</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ipcha <span class="op">=</span> <span class="va">ipcha</span>, ipchm <span class="op">=</span> <span class="va">ipchm</span>, ipch <span class="op">=</span> <span class="va">ipch</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<ol start="2" type="1">
<li>Dans <code>ipch.qmd</code> on met le chunk suivant (pas besoin de déclarer les libraries utilisées dans le script) :</li>
</ol>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://xtimbeau.github.io/sourcoise">sourcoise</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="va">ipch_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sourcoise.html">sourcoise</a></span><span class="op">(</span><span class="st">"ipch/prix_insee.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">ipch_data</span><span class="op">$</span><span class="va">ipchm</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">DATE</span>, y <span class="op">=</span> <span class="va">ipch</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>L’utilisation de <code><a href="../reference/sourcoise.html">sourcoise()</a></code> se fait comme celle de <code><a href="https://rdrr.io/r/base/source.html" class="external-link">base::source()</a></code> à l’assignement prêt. Le résultat est mis en cache et les exécution suivant prennent quelques millisecondes. Ces appels fonctionnent sans téléchargement et donc sasn erreur possible si le serveur d’Eurostat est hors ligne ou que l’on a plus d’internet.</p>
<p><code><a href="../reference/sourcoise.html">sourcoise()</a></code> dispose d’un cache (caché dans un dossier <code>.sourcoise</code>). Il repère le fichier source (le script) et détecte les changements, ce qui invalide le cache. Si le cache est valide, les données sont renvoyées, sinon, le script est exécuté et les nouvelles données mises en cache.</p>
<p>Il existe d’autres moyens d’invalider le cache : il peut avoir une durée de vie maximale, avec l’argument <code>lapse="day"</code>. Cette option dit que si le cache est plus vieux que 24h, il est renouvelé par une ré-exécution du script. Ce paramètre peut prendre plusieurs valeurs et des formes comme <code>2 hours</code> ou <code>3 weeks</code>. D’autres déclencheurs temporels seront possiblement ajoutés pour introduire des calendriers (comme 45 jours après la fin du trimestre). Cependant, <code><a href="../reference/sourcoise.html">sourcoise()</a></code> n’est pas capable d’aller vérifier (de façon générale) que les données téléchargées ont été mise à jour de plus et donc de ne pas invalider le cache sur cette base.</p>
<p>Il est aussi possible de déclencher l’invalidation du cache si un autre fichier a été modifié. Il suffit de fournir une liste de fichiers (dont les chemins sont relatifs au script) qui seront tracés. Ces fichiers peuvent être des <code>.csv</code> ou des fichiers <code>.xlsx</code> (ou encore tout autre type de fichier) et donc sont utiles pour déclencher l’exécution du script quand on a fait une modification manuelle ou par un autre programme de ces fichiers. On peut en mettre autant qu’on veut.</p>
<p>On peut également forcer le déclenchement du script. Cela se fait par une option <code>force_exec=TRUE</code>. Il existe d’autres moyens pour opérer un rafraîchissement du cache plus généraux.</p>
<p>Il est possible de bloquer l’exécution du code par une option (<code>prevent_exec</code>) qui peut être définie comme une option globale (par <code>options(ofce.sourcpose.prevent_exec=TRUE)</code>). Dans ce cas, aucun script ne sera exécuté, ce qui peut servir lorsqu’on veut faire un rendu du site sans prendre le risque d’une erreur d’API ou d’un blocage.</p>
<p>Il est possible de logger l’exécution de <code><a href="../reference/sourcoise.html">sourcoise()</a></code> pour vérifier que tout s’est bien passé et de répérer les accès aux données.</p>
<p>Une dernière chose, <code><a href="../reference/sourcoise.html">sourcoise()</a></code> est doté d’une heuristique maline trouve le fichier source même si il est caché (i.e. que le chemin est approximatif, ce qui déclenche une erreur normalement, mais là ça passe), ce qui augmente la portabilité des fichiers sources et facilite l’orgnisation d’un projet. Bien sûr, en cas d’ambiguité, <code><a href="../reference/sourcoise.html">sourcoise()</a></code> prévient.</p>
</section><section class="level2"><h3 id="performance">Performance<a class="anchor" aria-label="anchor" href="#performance"></a>
</h3>
<p>L’exécution “vraie” du scirpt <code>r</code> (sur un MacOS M2) prend 34ms et alloue 200kb. Lorsque les données sont en cache, l’exécution est effectuée en moins de 5ms et l’allocation de mémoire est celle des données finales.</p>
<pre><code>&gt; bench::mark(cache = sourcoise("work/ipch/prix_insee.r"), no_cache = sourcoise("work/ipch/prix_insee.r", force_exec = TRUE))
# A tibble: 2 × 13
  expression      min   median `itr/sec` mem_alloc `gc/sec` n_itr  n_gc total_time result       memory
  &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;   &lt;bch:tm&gt; &lt;list&gt;       &lt;list&gt;
1 cache         4.5ms    4.6ms     216.   188.63KB     11.0    98     5      455ms &lt;named list&gt; &lt;Rprofmem&gt;
2 no_cache     34.3ms   37.5ms      26.6    1.77MB     11.8     9     4      338ms &lt;named list&gt; &lt;Rprofmem&gt;
# ℹ 2 more variables: time &lt;list&gt;, gc &lt;list&gt;</code></pre>
</section><section class="level2"><h3 id="le-workflow-de-sourcoise">Le workflow de sourcoise<a class="anchor" aria-label="anchor" href="#le-workflow-de-sourcoise"></a>
</h3>
<p>Le cas central d’utilisation de sourcoise est dans un projet quarto. On acuiert des données de diférentes sources, plus ou moins complexes, nécessitant plus ou moins de traitements. Ces donénes peuvent être mises à jour, mais la fréquence de mise à jour est bien plus basse que la fréquence de rendu du projet quarto. Dans les chunks on place les mises en forme de graphiques ou de tableaux, afin de pouvoir les corriger et de pouvoir conserver l’adaptation des rendus aux support lors du <code>render</code> du projet quarto. Les données sont fabriquées dans les scripts <code>r</code>, placés là où sont les <code>qmd</code> et appelés périodiquement ou manuellement pour garantir que l’on dispose de la version à jour.</p>
<p>Ce projet quarto est partagé par github entre plusieurs utilisateurs et les données mises en cache sont commitées (et versionnées) par github. Cela permet de dissocier exécution des scripts (et vérification de leur bonne exécution) du rendu des graphiques ou tableaux faits à partir de ces données.</p>
<p><code><a href="../reference/sourcoise_status.html">sourcoise_status()</a></code> permet de faire un inventaire, pour le projet, de toutes les données en cache. Chaque fichier de donnée en cache, c’est-à-dire qui a été exéctué pleinement avec succès au moins une fois, est repéré (il existe quelque part dans le projet dans un dossier <code>.sourcoise</code>). Avec ce fichier, quelques informations sont conservés sur l’exécution (date, temps, taille des données) mais aussi sur le contexte d’exécution (script <code>r</code>, <code>qmd</code> appelants).</p>
<p><code><a href="../reference/sourcoise_refresh.html">sourcoise_refresh()</a></code> permet ainsi que rafraicher tout ou partie des données en cache en forçant l’exécution ou en laissant les schémas d’invalidation jouer automatiquement. lorsque les scripts sont exécutés par <code><a href="../reference/sourcoise_refresh.html">sourcoise_refresh()</a></code> le log est activé par défaut. Comme les <code>qmd</code> appelants sont connus, <code><a href="../reference/sourcoise_refresh.html">sourcoise_refresh()</a></code> peut <em>unfreezé</em> ou <em>uncaché</em> les <code>qmd</code>ou les chunks des <code>qmd</code>. C’est important dans le workflow, parce que lorsqu’on rafraichit les données, on veut que les chunks soient réévalués pour que les tableaux ou les graphiques soient refait à partir des nouvelles données. Or, si on utilise <code>freeze</code> quarto n’a pas de moyen de savoir que le <code>freeze</code> est périmé.</p>
<p>Il est possible de sélectionner les données qui sont rafraichies. <code><a href="../reference/sourcoise_refresh.html">sourcoise_refresh()</a></code> part du résulat de <code><a href="../reference/sourcoise_status.html">sourcoise_status()</a></code> par défaut. Il est ainsi possible de faire une sélection des données en cache et de ne passer que celles là à <code><a href="../reference/sourcoise_refresh.html">sourcoise_refresh()</a></code>. Avec un peu de programmation, on peut donc mettre en place un schéma qui régulièrement vérifie la validité des données (calendrier, API ou autre) et déclenche séelctivement la mise à jour. <code><a href="../reference/sourcoise.html">sourcoise()</a></code> peut appeler d’autres <code><a href="../reference/sourcoise.html">sourcoise()</a></code> mais pour le moment, il n’y a aucune prise en compte de cette hiérarchie.</p>
</section><section class="level2"><h3 id="usage-avancé">Usage avancé<a class="anchor" aria-label="anchor" href="#usage-avanc%C3%A9"></a>
</h3>
<section class="level3"><h4 id="passer-des-paramètres">Passer des paramètres<a class="anchor" aria-label="anchor" href="#passer-des-param%C3%A8tres"></a>
</h4>
<p>Il est possible de passer des paramètres avec <code><a href="../reference/sourcoise.html">sourcoise()</a></code>, bien que ce soit plus pratique d’écrire une fonction. Les paramètres sont passés sous forme d’une liste (<code>list(param1="1")</code> par exemple) et sont disponibles dans le script (dans la variable <code>args</code>, donc pour avoir le paramètre <code>param1</code> il faut écrire <code>args$param1</code> dans le script. Changer les paramètres invalide le cache.</p>
<p>Notez que le script est toujours exécuté en “local” ce qui veut dire que toute variable créée ou tout package ouvert à l’intérieur du script n’est pas renvoyé (comme dans une fonction, en fait).</p>
</section></section><section class="level2"><h3 id="usage-avancé-récupérer-les-métadonnées">Usage avancé : récupérer les métadonnées<a class="anchor" aria-label="anchor" href="#usage-avanc%C3%A9-r%C3%A9cup%C3%A9rer-les-m%C3%A9tadonn%C3%A9es"></a>
</h3>
<p>En utlisant l’option <code>metadata=TRUE</code> dans <code><a href="../reference/sourcoise.html">sourcoise()</a></code> on peut récupérer des informations sur, par exmple, la date de téléchargement. C’est illustré sur quelques graphiques du cachier de graphique.</p>
<p>En code cela donne le chunk ci dessous. Les données sont accessibles par <code>$data</code> et la date de téléchargement par <code>$date</code>. Cela permet de construire la note (noter que <code><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue::glue()</a></code> est appliqué aux textes passés à <code>ofce_caption()</code>).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">transactions</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sourcoise.html">sourcoise</a></span><span class="op">(</span><span class="st">"immo/data_transaction.r"</span>, metadata<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">trsc</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">transactions</span><span class="op">$</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">date</span>, y<span class="op">=</span><span class="va">t</span><span class="op">*</span><span class="fl">1000</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span>, col <span class="op">=</span> <span class="va">bluish</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point_interactive</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>tooltip <span class="op">=</span> <span class="va">tooltip</span>, data_id <span class="op">=</span> <span class="va">date</span><span class="op">)</span>,</span>
<span>                         shape <span class="op">=</span> <span class="fl">21</span>, size <span class="op">=</span> <span class="fl">1</span>, stroke <span class="op">=</span> <span class="fl">0.2</span>, col <span class="op">=</span> <span class="st">"white"</span>, </span>
<span>                         fill <span class="op">=</span> <span class="va">bluish</span>,</span>
<span>                         hover_nearest <span class="op">=</span> <span class="cn">TRUE</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_ofce</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_log10</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html" class="external-link">number_format</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">1000</span>, suffix<span class="op">=</span><span class="st">"k"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">scalex</span> <span class="op">+</span></span>
<span>  <span class="fu">ofce_caption</span><span class="op">(</span></span>
<span>    source <span class="op">=</span> <span class="st">"IGEDD d'après DGFiP (MEDOC) et bases notariale"</span>, </span>
<span>    dpt <span class="op">=</span> <span class="va">transactions</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">date</span>,</span>
<span>    note <span class="op">=</span> <span class="st">"Transactions cumulées sur 12 mois, dans l'ancien, maisons et appartements, échelle log, données téléchargées le {date_jour(transactions$date)}"</span>,</span>
<span>    sub<span class="op">=</span> <span class="st">"Nombre de transactions"</span><span class="op">)</span></span></code></pre></div>
<section class="level3"><h4 id="quelques-opérations-sur-le-cache">Quelques opérations sur le cache<a class="anchor" aria-label="anchor" href="#quelques-op%C3%A9rations-sur-le-cache"></a>
</h4>
<p>Le package <a href="https://xtimbeau.github.io/sourcoise">sourcoise</a> fournit des outils pour s’occuper des caches. Le premier est <code><a href="../reference/sourcoise_status.html">sourcoise_status()</a></code>. il scanne le répertoire et fournit la liste de tous les caches enregistrés et suivis. Il indique si les caches sont valides ou non et les principaux paramètres utilisés pour chaque script.</p>
<p><code><a href="../reference/sourcoise_refresh.html">sourcoise_refresh()</a></code> rafraîchit (en le forçant) tous les caches. On peut passer à <code><a href="../reference/sourcoise_refresh.html">sourcoise_refresh()</a></code> un <code>tibble</code> comme celui renvoyé par <code><a href="../reference/sourcoise_status.html">sourcoise_status()</a></code> mais filtré pour ne rafraîchir que la liste voulue (attention passer toutes les colonnes sans modification). Cela sert lorsqu’on a un processus plus complexe d’invalidation du cache (en fonction d’un calendrier, en interrogeant une API, etc…) et qu’on déclenche en fonction de cette logique l’exécution des caches.</p>
<p>On peut également à partir de <code><a href="../reference/sourcoise_status.html">sourcoise_status()</a></code> accéder aux données en cache. Elles sont enregistrées en <code>.qs2</code> avec les ackage <a href="https://github.com/qsbase/qs2" class="external-link">qs2</a> et donc se chargent avec un <code><a href="https://rdrr.io/pkg/qs2/man/qs_read.html" class="external-link">qs2::qs_read()</a></code>.</p>
<p>On peut également nettoyer complètement le cache (ce qui provoquera sa ré exécution) avec <code><a href="../reference/sourcoise_clear.html">sourcoise_clear()</a></code>.</p>
</section></section></section><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'light-border',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config);
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Xavier Timbeau.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
