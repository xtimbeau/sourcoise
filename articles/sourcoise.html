<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>sourcoise() : plus rapide, plus sûr • sourcoise</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="sourcoise_files/libs/quarto-html/popper.min.js"></script><script src="sourcoise_files/libs/quarto-html/tippy.umd.min.js"></script><link href="sourcoise_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="sourcoise_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="sourcoise() : plus rapide, plus sûr">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sourcoise</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/sourcoise.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>sourcoise() : plus rapide, plus sûr</h1>





      <div class="d-none name"><code></code></div>
    </div>






    <section class="level2"><h2 id="mettre-en-cache-le-résultat-des-calculs-avec-sourcoise">Mettre en cache le résultat des calculs avec <code>sourcoise()</code>
<a class="anchor" aria-label="anchor" href="#mettre-en-cache-le-r%C3%A9sultat-des-calculs-avec-sourcoise"></a>
</h2>
<p><code><a href="../reference/sourcoise.html">sourcoise()</a></code> est une fonction qui permet de mettre en cache les résultats d’un script <code>r</code> et de ne pas avoir à ré-exécuter le code à chaque fois.</p>
<p>Les bénéfices sont nombreux :</p>
<ol type="1">
<li>un gain de temps lorsque l’exécution du code est longue (accès à une API, téléchargement de grosses données, traitements importants). La lecture d’un fichier excel peut aussi être assez longue. Le temps d’accès aux données en cache dépend de leur taille, mais même pour des données volumineuses (et il n’y a pas de raisons qu’elles le soient tant que ça), l’ordre de grandeur est de qualques millisecondes, grâce aux optimisations.</li>
<li>le cache est transférable par github. Il se trouve dans un dossier (caché), mais enregistré dans le dossier de projet et <em>commité</em> par github. Le cache produit sur un poste est donc accessible par <code>pull</code> sur les autres postes.</li>
<li>si le code source déclenche une erreur, on peut passer outre : En cas de package non installé, données absentes (par exemple un chemin absolu dans le code), ou une API qui bloque (comme celle de l’OCDE) alors <code><a href="../reference/sourcoise.html">sourcoise()</a></code> essaye de prendre la dernière exécution résussie. Bien que cela puisse être problématique, c’est-à-dire une erreur non signalée, cela a l’énorme avantage de ne pas bloquer le processus et de permettre de traiter l’erreur en parallèle.</li>
<li>
<code><a href="../reference/sourcoise.html">sourcoise()</a></code> cherche de façon astucieuse le fichier source dans le projet et exécute le code dans un environnement local, en changeant le répertoire de travail pour être celui où se trouve le code source. Cela permet d’appeler dans le code source (le script <code>r</code> <code>mon_script.r</code> passé en paramètre à <code>sourcoise("mon_script.r")</code>, des scripts <code>r</code>, des fichiers de données <code>.csv</code> ou <code>.xlsx</code> qui sont enregistré dans le même répertoire que le fichier <code>mon_script.r</code>. On peut donc réutiliser le code sans se soucier de modifier les chemins qui sont relatifs au dossier où se trouve <code>mon_script.r</code>.</li>
<li>cela fournit un embryon de reproductibilité en désignant le script qui fabrique les données.</li>
</ol></section><section class="level2"><h2 id="comment-lutiliser">Comment l’utiliser ?<a class="anchor" aria-label="anchor" href="#comment-lutiliser"></a>
</h2>
<p>Première chose mettre son code de données dans un script et l’enregistrer là où est le qmd, dans cet exemple <code>souverains.qmd</code> et un dossier remplis de csv, scripts R, etc :</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> souverains</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">│  </span> ├── ratings.R</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">│  </span> ├── ratings.rds</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">│  </span> ├── ratings_legende.rds</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">│  </span> ├── ratings_taux.rds</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="ex">│  </span> ├── taux_souverains_historiques.R</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="ex">│  </span> └── taux_souverains_historiques.rds</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> souverains.qmd</span></code></pre></div>
<p>Dans <code>souverains.qmd</code> on trouve le chunk suivant. <code><a href="../reference/sourcoise.html">sourcoise()</a></code> est capable de retrouver le dossier dans le même dossier que le <code>qmd</code> (ce n’est pas automatique, dans un projet commme la prévision, les chemins sont relatifs à la racine du projet, ici le qmd et ses fichiers peuvent être mis n’importe où grâce à cette heuristique). Le source est ensuite exécuté en changeant le dossier de travail à celui qui le contient (dans cet exemple, <code>souverains</code>) ce qui permet d’utiliser des chemins relatifs et donc de pouvoir transporter le code n’importe où.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://xtimbeau.github.io/sourcoise">sourcoise</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">taux_souverains_historiques</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sourcoise.html">sourcoise</a></span><span class="op">(</span><span class="st">"souverains/taux_souverains_historiques.R"</span>, lapse <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ratings_taux</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sourcoise.html">sourcoise</a></span><span class="op">(</span><span class="st">"souverains/ratings"</span>, lapse <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span></span></code></pre></div>
<p>Le script doit se terminer par un <code>return</code> qui renvoie les données calculées ou téléchargées. Ce sont ces données qui sont mises en cache.</p>
<pre><code>```r
library(INSEE)
library(tidyverse)
...
télécharge et modifie, calcule, etc
...
return(taux_souverains_historiques)
```</code></pre>
<p><code><a href="../reference/sourcoise.html">sourcoise()</a></code> dispose d’un cache (caché dans un dossier <code>.data</code>). Il repère le fichier source et détecte les changements faits au code source et invalide le cache. Si le cache est valide, les données sont renvoyées, sinon, le script est exécuté et les nouvelles données mises en cache.</p>
<p>Il existe d’autres moyens d’invalider le cache : il peut avoir une durée de vie maximale, comme avec l’argument <code>lapse="day"</code>. Cette option dit que si le cache est plus vieux que 24h, il est renouvelé par une ré-exécution du script. Ce paramètre peut prendre plusieurs valeurs et des formes comme <code>2 hours</code> ou <code>3 weeks</code>. D’autres déclencheurs temporels seront ajoutés pour introduire des calendriers (comme 45 jours après la fin du trimestre). Attention, cependant, <code>source_cache</code> n’est pas capable d’aller vérifier que les données téléchargées ont un point de plus et donc de ne pas valider le cache si la donnée n’a pas encore été publiée.</p>
<p>Il est aussi possible de déclencher l’invalidation du cache si un fichier a été modifié. Il suffit de fournir une liste de fichiers (dont les chemins sont relatifs au script) qui seront suivis. Ces fichiers peuvent être des <code>.csv</code> ou des fichiers <code>.xlsx</code> (ou encore tout autre type de fichier) et donc sont utiles pour déclencher l’exécution du script quand on a fait une modification manuelle ou par un autre programme de ces fichiers. On peut en mettre autant qu’on veut.</p>
<p>On peut également forcer le déclenchement du script. Cela se fait par une option <code>force_exec=TRUE</code>. Cependant, il vaut mieux ne pas spécifier cette option, il existe d’autres moyens pour opérer un rafraîchissement du cache.</p>
<p>Il est possible de bloquer l’exécution du code par une option (<code>prevent_exec</code>) qui peut être définie comme une option globale (par <code>options(ofce.source_data.prevent_exec=TRUE)</code>). Dans ce cas, aucun script ne sera exécuté, ce qui peut servir lorsqu’on veut faire un rendu du site sans prendre le risque d’une erreur d’API ou d’un blocage.</p>
</section><section class="level2"><h2 id="usage-avancé-passer-des-paramètres">Usage avancé : passer des paramètres<a class="anchor" aria-label="anchor" href="#usage-avanc%C3%A9-passer-des-param%C3%A8tres"></a>
</h2>
<p>Il est possible de passer des paramètres avec <code><a href="../reference/sourcoise.html">sourcoise()</a></code>, bien que ce soit plus pratique d’écrire une fonction. Les paramètres sont passés sous forme d’une liste (<code>list(param1="1")</code> par exemple) et sont disponibles dans le script (dans la variable <code>args</code>, donc pour avoir le paramètre <code>param1</code> il faut écrire <code>args$param1</code> dans le script. Changer les paramètres invalide le cache.</p>
<p>Notez que le script est toujours exécuté en “local” ce qui veut dire que toute variable créée ou tout package ouvert à l’intérieur du script n’est pas renvoyé (comme dans une fonction, en fait).</p>
</section><section class="level2"><h2 id="usage-avancé-récupérer-les-métadonnées">Usage avancé : récupérer les métadonnées<a class="anchor" aria-label="anchor" href="#usage-avanc%C3%A9-r%C3%A9cup%C3%A9rer-les-m%C3%A9tadonn%C3%A9es"></a>
</h2>
<p>En utlisant l’option <code>metadata=TRUE</code> dans <code><a href="../reference/sourcoise.html">sourcoise()</a></code> on peut récupérer des informations sur, par exmple, la date de téléchargement. C’est illustré sur quelques graphiques du cachier de graphique.</p>
<p>En code cela donne le chunk ci dessous. Les données sont accessibles par <code>$data</code> et la date de téléchargement par <code>$date</code>. Cela permet de construire la note (noter que <code><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue::glue()</a></code> est appliqué aux textes passés à <code>ofce_caption()</code>).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">transactions</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sourcoise.html">sourcoise</a></span><span class="op">(</span><span class="st">"immo/data_transaction.r"</span>, metadata<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">trsc</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">transactions</span><span class="op">$</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">date</span>, y<span class="op">=</span><span class="va">t</span><span class="op">*</span><span class="fl">1000</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span>, col <span class="op">=</span> <span class="va">bluish</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point_interactive</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>tooltip <span class="op">=</span> <span class="va">tooltip</span>, data_id <span class="op">=</span> <span class="va">date</span><span class="op">)</span>,</span>
<span>                         shape <span class="op">=</span> <span class="fl">21</span>, size <span class="op">=</span> <span class="fl">1</span>, stroke <span class="op">=</span> <span class="fl">0.2</span>, col <span class="op">=</span> <span class="st">"white"</span>, </span>
<span>                         fill <span class="op">=</span> <span class="va">bluish</span>,</span>
<span>                         hover_nearest <span class="op">=</span> <span class="cn">TRUE</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_ofce</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_log10</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html" class="external-link">number_format</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">1000</span>, suffix<span class="op">=</span><span class="st">"k"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">scalex</span> <span class="op">+</span></span>
<span>  <span class="fu">ofce_caption</span><span class="op">(</span></span>
<span>    source <span class="op">=</span> <span class="st">"IGEDD d'après DGFiP (MEDOC) et bases notariale"</span>, </span>
<span>    dpt <span class="op">=</span> <span class="va">transactions</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">date</span>,</span>
<span>    note <span class="op">=</span> <span class="st">"Transactions cumulées sur 12 mois, dans l'ancien, maisons et appartements, échelle log, données téléchargées le {date_jour(transactions$date)}"</span>,</span>
<span>    sub<span class="op">=</span> <span class="st">"Nombre de transactions"</span><span class="op">)</span></span></code></pre></div>
</section><section class="level2"><h2 id="quelques-opérations-sur-le-cache">Quelques opérations sur le cache<a class="anchor" aria-label="anchor" href="#quelques-op%C3%A9rations-sur-le-cache"></a>
</h2>
<p>Le package <a href="https://xtimbeau.github.io/sourcoise">sourcoise</a> fournit des outils pour s’occuper des caches. Le premier est <code><a href="../reference/sourcoise_status.html">sourcoise_status()</a></code>. il scanne le répertoire et fournit la liste de tous les caches enregistrés et suivis. Il indique si les caches sont valides ou non et les principaux paramètres utilisés pour chaque script.</p>
<p><code><a href="../reference/sourcoise_refresh.html">sourcoise_refresh()</a></code> rafraîchit (en le forçant) tous les caches. On peut passer à <code><a href="../reference/sourcoise_refresh.html">sourcoise_refresh()</a></code> un <code>tibble</code> comme celui renvoyé par <code><a href="../reference/sourcoise_status.html">sourcoise_status()</a></code> mais filtré pour ne rafraîchir que la liste voulue (attention passer toutes les colonnes sans modification). Cela sert lorsqu’on a un processus plus complexe d’invalidation du cache (en fonction d’un calendrier, en interrogeant une API, etc…) et qu’on déclenche en fonction de cette logique l’exécution des caches.</p>
<p>On peut également à partir de <code><a href="../reference/sourcoise_status.html">sourcoise_status()</a></code> accéder aux données en cache. Elles sont enregistrées en <code>.qs2</code> avec les ackage <a href="https://github.com/qsbase/qs2" class="external-link">qs2</a> et donc se chargent avec un <code><a href="https://rdrr.io/pkg/qs2/man/qs_read.html" class="external-link">qs2::qs_read()</a></code>.</p>
<p>On peut également nettoyer complètement le cache (ce qui provoquera sa ré exécution) avec <code><a href="../reference/sourcoise_clear.html">sourcoise_clear()</a></code>.</p>
</section><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'light-border',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config);
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Xavier Timbeau.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
