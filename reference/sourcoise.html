<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>sources R script and caches results on disk — sourcoise • sourcoise</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="sources R script and caches results on disk — sourcoise"><meta name="description" content="sourcoise() is used as a drop in replacement for base::source() but caches results on disk. Cache is persistant over sessions."><meta property="og:description" content="sourcoise() is used as a drop in replacement for base::source() but caches results on disk. Cache is persistant over sessions."><meta property="og:image" content="https://xtimbeau.github.io/sourcoise/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sourcoise</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/sourcoise.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/advanced.html">Usages avancés</a></li>
    <li><a class="dropdown-item" href="../articles/compared.html">Comparé à ...</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/xtimbeau/sourcoise/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>sources R script and caches results on disk</h1>
      <small class="dont-index">Source: <a href="https://github.com/xtimbeau/sourcoise/blob/main/R/sourcoise.R" class="external-link"><code>R/sourcoise.R</code></a></small>
      <div class="d-none name"><code>sourcoise.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><code>sourcoise()</code> is used as a drop in replacement for <code><a href="https://rdrr.io/r/base/source.html" class="external-link">base::source()</a></code> but caches results on disk. Cache is persistant over sessions.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">sourcoise</span><span class="op">(</span></span>
<span>  <span class="va">path</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  track <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  lapse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"sourcoise.lapse"</span><span class="op">)</span>,</span>
<span>  force_exec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"sourcoise.force_exec"</span><span class="op">)</span>,</span>
<span>  prevent_exec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"sourcoise.prevent_exec"</span><span class="op">)</span>,</span>
<span>  metadata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"sourcoise.metadata"</span><span class="op">)</span>,</span>
<span>  wd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"sourcoise.wd"</span><span class="op">)</span>,</span>
<span>  src_in <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"sourcoise.src_in"</span><span class="op">)</span>,</span>
<span>  exec_wd <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  root <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  nocache <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  inform <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  log <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"sourcoise.log"</span><span class="op">)</span>,</span>
<span>  grow_cache <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"sourcoise.grow_cache"</span><span class="op">)</span>,</span>
<span>  limit_mb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"sourcoise.limit_mb"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-path">path<a class="anchor" aria-label="anchor" href="#arg-path"></a></dt>
<dd><p>(character) path of the script to execute (see details).</p></dd>


<dt id="arg-args">args<a class="anchor" aria-label="anchor" href="#arg-args"></a></dt>
<dd><p>(list) list of args that can be used in the script (in the form <code>args$xxx</code>).</p></dd>


<dt id="arg-track">track<a class="anchor" aria-label="anchor" href="#arg-track"></a></dt>
<dd><p>(list) list of files which modification triggers cache invalidation and script execution .</p></dd>


<dt id="arg-lapse">lapse<a class="anchor" aria-label="anchor" href="#arg-lapse"></a></dt>
<dd><p>(character) duration over which cache is invalidated. Could be <code>never</code> (default) <code>x hours</code>, <code>x days</code>, <code>x week</code>, <code>x months</code>, <code>x quarters</code>, <code>x years</code>.</p></dd>


<dt id="arg-force-exec">force_exec<a class="anchor" aria-label="anchor" href="#arg-force-exec"></a></dt>
<dd><p>(boolean) execute code, disregarding cache valid or invalid.</p></dd>


<dt id="arg-prevent-exec">prevent_exec<a class="anchor" aria-label="anchor" href="#arg-prevent-exec"></a></dt>
<dd><p>(boolean) prevent execution, cache valid or not, returned previous cached data, possibly invalid.</p></dd>


<dt id="arg-metadata">metadata<a class="anchor" aria-label="anchor" href="#arg-metadata"></a></dt>
<dd><p>(boolean) if TRUE <code>sourcoise()</code> returns a list with data is the <code>$data</code>  and various meta data (see details).</p></dd>


<dt id="arg-wd">wd<a class="anchor" aria-label="anchor" href="#arg-wd"></a></dt>
<dd><p>(character) if <code>project</code> working directory for the execution of script will be the root of the project. If <code>file</code> then it will be the dir of the script (défaut) If <code>qmd</code>, then working dir will be the dir in which the calling <code>qmd</code> is. Current directory is restored after execution (successful or failed).</p></dd>


<dt id="arg-src-in">src_in<a class="anchor" aria-label="anchor" href="#arg-src-in"></a></dt>
<dd><p>(character) if <code>project</code> searches for source starting at the root of the project, if "file" searches in qmd dir. If "wd", then in working directory. Cache folder (<code>.sourcoise</code>) is stored there.</p></dd>


<dt id="arg-exec-wd">exec_wd<a class="anchor" aria-label="anchor" href="#arg-exec-wd"></a></dt>
<dd><p>(character) force exec dir (expert use).</p></dd>


<dt id="arg-root">root<a class="anchor" aria-label="anchor" href="#arg-root"></a></dt>
<dd><p>(character) force root (expert use).</p></dd>


<dt id="arg-quiet">quiet<a class="anchor" aria-label="anchor" href="#arg-quiet"></a></dt>
<dd><p>(boolean) mute messages and warnings from script execution.</p></dd>


<dt id="arg-nocache">nocache<a class="anchor" aria-label="anchor" href="#arg-nocache"></a></dt>
<dd><p>(boolean) no caching.</p></dd>


<dt id="arg-inform">inform<a class="anchor" aria-label="anchor" href="#arg-inform"></a></dt>
<dd><p>(boolean) Display logs on console, even if logging is disabled with threshold level "INFO".</p></dd>


<dt id="arg-log">log<a class="anchor" aria-label="anchor" href="#arg-log"></a></dt>
<dd><p>("OFF" par défaut) log threshold (see <code>logger::log_treshold()</code>).</p></dd>


<dt id="arg-grow-cache">grow_cache<a class="anchor" aria-label="anchor" href="#arg-grow-cache"></a></dt>
<dd><p>(5 par défaut) cache limit in number of data file kept.</p></dd>


<dt id="arg-limit-mb">limit_mb<a class="anchor" aria-label="anchor" href="#arg-limit-mb"></a></dt>
<dd><p>(50 par défaut) individual cache data files size on disk limit. If above <strong>no caching</strong>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>data (list ou ce que le code retourne)</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p><code>sourcoise()</code> looks like <code><a href="https://rdrr.io/r/base/source.html" class="external-link">base::source()</a></code>. However, there are some minor differences.</p>
<p>First, the script called in <code>sourcoise()</code> must end by a <code><a href="https://rdrr.io/r/base/function.html" class="external-link">return()</a></code> or by an object returned. Assignment made in the script won't be kept as <code>sourcoise()</code> is executed locally. Only explicitly reruned object will be returned. So <code>soucoise()</code> is used by assigning its result to something (<code>aa &lt;- sourcoise("mon_script.r)</code> or <code>sourcoise() |&gt; ggplot() ...</code>). Unless specified otherwise with <code>wd</code> parameter, the working directory for the script execution is (temporarly) set to the dir in which is the script. That allows for simple access to companion files and permit to move the script and companion files to another dir or project.</p>
<p>Second, an heuristic is applied to find the script, in the event the path given is incomplete. Whereas it is not advised and comes with a performance cost, this can be useful when there is a change in the structure of the project. The heuristic is simple, the script is searched inside the porject dir and among all hits the closest to the caller is returned.</p>
<p>Third, if an error is triggered by the script, <code>sourcoise()</code> does not fail and return the error and a NULL return. However, if there is a (invalid or valid) cache, the cached data is returned allowing for the script to continue. In that case the error is logged.</p>
<p>Cache is invalidated when :
1 -   a cache is not found
2 -   the script has been modified
3 -   tracked files have been modified
4 -   last execution occurred a certain time ago and is considered as expired
5 -   execution is forced</p>
<p>If <code>src_in="file"</code>, then script <code>path</code> is searched from the <code>.qmd</code> dir. If no <code>.qmd</code> esxits (or is not the caller) the the current work dir is used (which is the usual way <code><a href="https://rdrr.io/r/base/source.html" class="external-link">base::source</a></code> works).
If <code>src_in="project"</code>, then script <code>path</code> is searched from the root dir of the project, being a Rproject or a quarto project, using the package <code>{rprojroot}</code>. This guarantees to find the script without using current working directory and is a more robust way to proceed.</p>
<p>Usually the fisrt call return and cache the results. Results can be aby R object and are serialized and saved using <code>qs2</code>. Subsequent calls, supposing none of cache invalidation are true, are then very quick. No logging is used, data is fecteched from the cache and that's it. For standard size data, used in a table or a graph (&lt; 1Mb roughly), return timing is under 5ms.</p>
<p><code>lapse</code> parameter is used for invalidation trigger 4. <code>lapse = "1 day"</code> ou <code>lapse="day"</code> for instance will trigger once a day the execution. <code>lapse = "3 days"</code> will do it every 72h. <code>hours</code>, <code>weeks</code>, <code>months</code>, <code>quarters</code> or <code>years</code> are understood time units. MOre complex calendar instructions could be added, but <code>sourcoise_refesh()</code> provides a solution more general and easy to adapt to any use case, as to my knowledge, there is no general mechanism to be warned of data updates.</p>
<p><code>track</code> is the trigger #3. It is simply a list of files (following path convention defined by <code>scr_in</code>, so either script dir of project dir as reference). If the files in the list are changed then the execution is triggered. It is done with a hash and it is difficult to have a croo plateform hash for excel files. Nevertheless, hash is done on text files with same results of different platforms.</p>
<p>If <code>metadata=TRUE</code>, a list is returned, with some metadatas. Main ones are <code>$data</code>, the data returned, <code>$date</code>, execution date, <code>$timing</code> execution timing, <code>$size</code> of the R object in memory, <code>$data_file</code> and <code>"data_date</code> documenting data file path and last modification date (see below), parameters of the call (<code>$track</code>, <code>$wd</code>, <code>$src_in</code>, <code>$args</code> and so on).</p>
<p><code>force_exec</code> and <code>prevent_exec</code> are parameters that force the script execution (trigger #5) of prevent it (so cache is returned or NULL if no cache). Those 2 parameters can be set for one specific execution, but they are intendend to a global setting through the option <code>sourcoise.force_exec</code> or <code>sourcoise.prevent_exec</code>.</p>
<p>If returned data after execution is not different than previously cached data, then no caching occurs in order to limit the disk use and to avoid keeping an histoiry of the same data files. This implies the possibility of a difference between last execution date and last data modification date.</p>
<p>Working with github : <code>sourcoise()</code> is designed to function with <em>github</em>. Cache information is specific to each user (avoiding conflicts) and cached data is named with the hash. Conflicts could occur in the rare case the same script is executed on different machines and that this script return each time a different result (such as a random generator).</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>Other sourcoise:
<code><a href="sourcoise_clear.html">sourcoise_clear</a>()</code>,
<code><a href="sourcoise_refresh.html">sourcoise_refresh</a>()</code>,
<code><a href="sourcoise_reset.html">sourcoise_reset</a>()</code>,
<code><a href="sourcoise_status.html">sourcoise_status</a>()</code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/copy.html" class="external-link">file_copy</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>   <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path_package.html" class="external-link">path_package</a></span><span class="op">(</span><span class="st">"sourcoise"</span>, <span class="st">"ipch"</span>, <span class="st">"prix_insee.R"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  <span class="st">"/tmp/prix_insee.r"</span>,</span></span>
<span class="r-in"><span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Force execution (root is set explicitly here, it is normally deduced from project)</span></span></span>
<span class="r-in"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">sourcoise</span><span class="op">(</span><span class="st">"prix_insee.r"</span>, root <span class="op">=</span> <span class="st">"/tmp/"</span>, force_exec <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># The second time cache is used</span></span></span>
<span class="r-in"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">sourcoise</span><span class="op">(</span><span class="st">"prix_insee.r"</span>, root <span class="op">=</span> <span class="st">"/tmp/"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Performance and mem test</span></span></span>
<span class="r-in"><span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/copy.html" class="external-link">file_copy</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>   <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path_package.html" class="external-link">path_package</a></span><span class="op">(</span><span class="st">"sourcoise"</span>, <span class="st">"ipch"</span>, <span class="st">"prix_insee.R"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  <span class="st">"/tmp/prix_insee.r"</span>,</span></span>
<span class="r-in"><span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span></span>
<span class="r-in"><span> forced <span class="op">=</span> <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">sourcoise</span><span class="op">(</span><span class="st">"prix_insee.r"</span>, root <span class="op">=</span> <span class="st">"/tmp/"</span>, force_exec <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span></span>
<span class="r-in"><span> cached <span class="op">=</span> <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">sourcoise</span><span class="op">(</span><span class="st">"prix_insee.r"</span>, root <span class="op">=</span> <span class="st">"/tmp/"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 2 × 13</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   expression     min  median `itr/sec` mem_alloc `gc/sec` n_itr  n_gc total_time</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;bch:expr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;bch:t&gt;</span> <span style="color: #949494; font-style: italic;">&lt;bch:t&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;bch:byt&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;bch:tm&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">1</span> forced     79.78ms 80.94ms      11.2    1.92MB     0        6     0      536ms</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">2</span> cached      8.91ms  9.04ms     110.   248.38KB     4.68    47     2      428ms</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># ℹ 4 more variables: result &lt;list&gt;, memory &lt;list&gt;, time &lt;list&gt;, gc &lt;list&gt;</span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Xavier Timbeau.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

